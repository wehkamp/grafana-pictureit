{"version":3,"sources":["../src/pictureit_ctrl.js"],"names":["_","MetricsPanelCtrl","kbn","Emitter","panelDefaults","valueMaps","seriesList","series","bgimage","sensors","height","width","PictureItCtrl","$scope","$injector","defaults","panel","bindThis","events","on","onInitEditMode","bind","render","onDataReceived","hiddenImg","Image","addEventListener","refImageSize","w","naturalWidth","h","naturalHeight","src","dataList","dataListLength","length","push","name","target","value","datapoints","index","splice","xlocation","ylocation","format","decimals","bgcolor","color","size","currentSize","bordercolor","visible","lastSensor","subItem","addEditorTab","editModeInterval","refresher","setInterval","emit","scope","elem","attrs","ctrl","$panelContainer","find","pixelStrToNum","str","parseInt","substr","console","log","editMode","clearInterval","refImage","document","getElementById","clientHeight","clientWidth","style","span","spanRatio","css","sensorsLength","valueMapsLength","imageHeight","imageWidth","originalHeight","originalWidth","sensor","calculatedYPos","calculatedXPos","ylocationStr","toString","xlocationStr","lastSize","sizeStr","valueMap","valueFormatted","valueFormats","renderingCompleted","templateUrl"],"mappings":"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","file":"pictureit_ctrl.js","sourcesContent":["import _ from 'lodash';\nimport { MetricsPanelCtrl } from 'app/plugins/sdk';\nimport './sprintf.js';\nimport './angular-sprintf.js';\nimport kbn from 'app/core/utils/kbn';\n\nimport { Emitter } from 'app/core/core';\n\nconst panelDefaults = {\n    valueMaps: [],\n    seriesList: [],\n    series: [],\n    bgimage: '',\n    sensors: [],\n    height: '400px',\n    width: '100px'\n};\n\nexport class PictureItCtrl extends MetricsPanelCtrl {\n\n    constructor($scope, $injector) {\n        super($scope, $injector);\n        _.defaults(this.panel, panelDefaults);\n        var bindThis = this;\n        this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n        this.events.on('panel-initialized', this.render.bind(this));\n        this.events.on('data-received', this.onDataReceived.bind(this));\n        this.events.on('data-snapshot-load', this.onDataReceived.bind(this));\n        this.hiddenImg = new Image();\n        this.hiddenImg.addEventListener(\"load\", function () {\n            bindThis.refImageSize = { w: this.naturalWidth, h: this.naturalHeight }\n        });\n        this.hiddenImg.src = this.panel.bgimage;\n    }\n\n    onDataReceived(dataList) {\n        var dataListLength = dataList.length;\n        this.panel.valueMaps = [];\n        for (var series = 0; series < dataListLength; series++) {\n            this.panel.valueMaps.push({\n                name: dataList[series].target,\n                value: dataList[series].datapoints[dataList[series].datapoints.length - 1][0]\n            });\n        }\n\n        this.render();\n    }\n\n    deleteSensor(index) {\n        this.panel.sensors.splice(index, 1);\n    }\n\n    addSensor() {\n        if (this.panel.sensors.length == 0)\n            this.panel.sensors.push({\n                name: 'A-series',\n                xlocation: 200,\n                ylocation: 200,\n                format: 'none',\n                decimals: 'auto',\n                bgcolor: 'rgba(0, 0, 0, 0.58)',\n                color: '#FFFFFF',\n                size: 22,\n                currentSize: 22,\n                bordercolor: 'rgb(251, 4, 4)',\n                visible: true\n            });\n        else {\n            var lastSensor = this.panel.sensors[this.panel.sensors.length - 1];\n\n            this.panel.sensors.push({\n                name: lastSensor.name,\n                xlocation: 200,\n                ylocation: 200,\n                format: lastSensor.format,\n                decimals: lastSensor.decimals,\n                bgcolor: lastSensor.bgcolor,\n                color: lastSensor.color,\n                size: lastSensor.size,\n                currentSize: lastSensor.size,\n                bordercolor: lastSensor.bordercolor,\n                visible: true\n            });\n        }\n    }\n\n    setUnitFormat(subItem, index) {\n        this.panel.sensors[index].format = subItem.value;\n    }\n\n    onInitEditMode() {\n        this.addEditorTab('Options', 'public/plugins/bessler-pictureit-panel/editor.html', 2);\n        var bindThis = this;\n        this.editModeInterval = true;\n        this.refresher = setInterval(function () {\n            bindThis.events.emit('panel-initialized');\n        }, 1000);\n    }\n\n    link(scope, elem, attrs, ctrl) {\n        var sensors;\n        var valueMaps;\n\n        const $panelContainer = elem.find('.panel-container');\n\n        function pixelStrToNum(str) {\n            return parseInt(str.substr(0, str.length - 2));\n        }\n\n        function render() {\n            if (!ctrl.panel.sensors) {\n                return;\n            }\n            console.log(scope);\n            if (ctrl.editMode && !ctrl.editModeInterval) {\n                ctrl.editModeInterval = true;\n                ctrl.refresher = setInterval(function () {\n                    ctrl.events.emit('panel-initialized');\n                }, 1000);\n            } else if (!ctrl.editMode) {\n                ctrl.editModeInterval = false;\n                clearInterval(ctrl.refresher);\n            }\n            var refImage = document.getElementById('imageRef');\n            if (!refImage) {\n                return;\n            }\n            if (refImage.clientHeight > refImage.clientWidth) {\n                refImage.style = \"width: auto; visibility: hidden; position: absolute\";\n            }\n\n            var span = ctrl.panel.span;\n            var spanRatio = span / 12;\n            //refImage.style='height:auto; width:'+100 * spanRatio+'%';\n            refImage.style='width:100%';\n            console.log(refImage.clientHeight);\n            ctrl.panel.height = refImage.clientHeight;\n            var width = pixelStrToNum($panelContainer.css(\"width\"));\n            var height = pixelStrToNum($panelContainer.css(\"height\"));\n\n            sensors = ctrl.panel.sensors;\n            valueMaps = ctrl.panel.valueMaps;\n            var sensorsLength = sensors.length;\n            var valueMapsLength = valueMaps.length;\n            var imageHeight = refImage.clientHeight;\n            var imageWidth = refImage.clientWidth;\n            var originalHeight = ctrl.refImageSize.h;\n            var originalWidth = ctrl.refImageSize.w;\n            for (var sensor = 0; sensor < sensorsLength; sensor++) {\n                sensors[sensor].visible = sensors[sensor].xlocation < width && sensors[sensor].ylocation < height;\n                var calculatedYPos = imageHeight * sensors[sensor].ylocation / originalHeight;\n                var calculatedXPos = imageWidth * sensors[sensor].xlocation / originalWidth;\n                sensors[sensor].ylocationStr = (calculatedYPos).toString() + \"px\";\n                sensors[sensor].xlocationStr = (calculatedXPos).toString() + \"px\";\n                sensors[sensor].lastSize = imageWidth * sensors[sensor].size / originalWidth;\n                sensors[sensor].sizeStr = imageWidth * sensors[sensor].size / originalWidth + \"px\";\n                for (var valueMap = 0; valueMap < valueMapsLength; valueMap++) {\n                    if (sensors[sensor].name == valueMaps[valueMap].name) {\n                        sensors[sensor].valueFormatted = kbn.valueFormats[sensors[sensor].format](valueMaps[valueMap].value, sensors[sensor].decimals, null);\n                        break;\n                    }\n                }\n            }\n\n        }\n\n        this.events.on('render', function () {\n            render();\n            ctrl.renderingCompleted();\n        });\n    }\n}\n\nPictureItCtrl.templateUrl = 'module.html';\n"]}